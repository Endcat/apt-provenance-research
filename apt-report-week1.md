## 0x01 任务概览

- 渗透攻击（信息收集/漏洞扫描/漏洞利用/实施攻击/后渗透攻击）
- 攻击复现，从日志查看端倪（多部攻击/分步骤的攻击比较容易）
- 把攻击和日志一一对应起来

## 0x02 探索记录

### 第一次尝试：CVE-2016-10134

#### 环境搭建

这里找一个简单的分步骤的现有攻击复现流程。首先尝试一下SQL注入的攻击复现，复现的漏洞是Zabbix SQL注入漏洞（CVE-2016-10134）。首先要准备搭建漏洞环境，使用了开源项目vulhub的开源docker镜像库进行快速搭建：

```bash
# 下载vulhub最新版本
git clone https://github.com/vulhub/vulhub.git

# cd进入环境目录
cd /vulhub/zabbix/CVE-2016-10134

# 启动docker
docker-compose up -d
```

完成后访问`localhost:8080`即可：

![image-20200529122448855](https://picturefac.oss-cn-hangzhou.aliyuncs.com/img/20200529122448.png)

因为重点不在分析漏洞原理上，只要注重执行每一步攻击步骤时是否产生了对应的log日志，其实从漏洞环境一开始构建的时候就已经产生了很多日志文件。Windows下的Docker Desktop比较能够方便查看日志信息：

![image-20200529123850770](https://picturefac.oss-cn-hangzhou.aliyuncs.com/img/20200529123850.png)

当然因为我没有执行攻击步骤，所以这时候的日志没啥有价值的信息。





#### 攻击步骤

首先以游客身份`guest`登录

然后得到`cookies`中的`zbx_sessionid`的后16位值

![image-20200529131527860](https://picturefac.oss-cn-hangzhou.aliyuncs.com/img/20200529131527.png)

构造payload：

```
http://localhost:8080/latest.php?output.php=ajax&sid=[这里填入后16位sessionid]&favobj=toggle&toggle_open_state=1&toggle_ids=updatexml(0,concat(0xa,database()),0)
```

![image-20200529132437144](https://picturefac.oss-cn-hangzhou.aliyuncs.com/img/20200529132437.png)

但是发现了在注入的过程中，日志没有任何可疑的变化。我怀疑是Docker没有实时更新数据，所以直接查看容器中的log文件，mysql的log文件在`/var/log/mysql`下，查看发现确实没有改变。我的日志溯源工作第一次出现了困难。

事后稍微翻了一下百度，可能是因为我查看的mysql日志文件为错误日志，而不是查询日志。错误日志更多的是记录mysql服务本身的运行时的错误信息，而不是查询sql是的记录。而且日志文件需要配置路径，在原CVE-2016-10134容器中我并没有找到查询相关的日志，又是卡了很久一段时间。最后还是决定换一种方法。

### 第二次尝试

专门用来复现攻击的docker镜像，日志功能可能会有删减（猜测）。这次我直接用我博客的云服务器，看一下日常的日志内容。这里查看的是apache访问日志`/var/log/apache2/access.log`

admin

![image-20200529163012056](https://picturefac.oss-cn-hangzhou.aliyuncs.com/img/20200529163012.png)

可以很方便的看到每次访问中请求的ip地址/请求的时间/以及请求的url路径和user-agent等等信息。我试着访问了一下我的网站，果然日志里马上就出现了很多的记录（去除了一些敏感信息）：

```
60.***.***.139 - - [29/May/2020:20:03:59 +0800] "GET /wp-content/uploads/2019/01/23050135.jpg HTTP/1.1" 200 254672 "https://我的博客.cn/" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.61 Safari/537.36"
```

都是诸如类似的一些记录，也不难推测如果我要实现的是sql注入攻击，在get请求下可以清楚看到一长串由攻击方构造的payload。再仔细看的话，可以发现类似日志记录其实是有规律可寻的。按照先后次序依次展现的信息有：请求方ip地址/时间/请求方式/请求url/协议/状态码/根域名/user-agent。这个规定实际上在apache的httpd.conf文件中有定义：

```
LogFormat "%h %l %u %t \"%r\" %>s %b" common
```

然后就推测除了apache日志以外，其他日志都应当有一定的格式。在攻击溯源的工作中确定日志的格式是基础，根据格式能分离出不同的信息，从不同的信息可以对攻击者和攻击行为进行画像。

## 0x03 小结

### 有没有完成了任务

我认为没有达到要求，至少我没有成功的把真正的能够反映出“被黑客攻击了”的日志拿出来，只是把正常的请求一一对应找了出来。失败的原因是多方面的：自己很少有搭建环境复现攻击的时候，所以这方面花的时间比较多。然后具体的被攻击方的平台日志，比如说复现CVE时候的Zabbix，就是找不到，很头疼，想了好几天。虽然是个开源项目，文档里也没找到有用的消息（懒得翻完）。

最后还是拿自己的服务器，试了一下简单的请求。自己在建站的时候对apache和wordpress还是比较熟悉一点。

### 学到了什么

主要是巩固了复现攻击和查看日志的“肌肉记忆”。通过日志对照的过程其实让我回想起了自己在参加电子取证竞赛的时候遇到的攻击溯源的问题。针对日志的攻击溯源涉及了很多东西。针对日志来说，除了我在重现“一方请求，一方日志生成”的过程中提到的apache，如果攻击方达成了getshell，在linux服务器下有`/var/run/utmp`、`/var/run/wtmp`、`/var/run/btmp`记录了用户的登录信息。`.bash_history`记录的是bash的键入记录等等。

### 思考

如何解决攻击溯源的问题呢？解决问题得先想一下已知条件有哪些？未知要素有哪些？显然未知的东西就是攻击者的详细信息（包括不限于ip地址、攻击手段），已知的条件是攻击者的脚印——日志（本质上就是有格式的文本罢了）

布置任务的时候也提到了一个问题：在实际环境下，日志同时记录了正常用户和攻击者的记录，如何分离？

首先得拿到所有请求ip地址，创建一个map映射。比如说我可以这样：

| ip_address   | value                                          |
| ------------ | ---------------------------------------------- |
| 请求的ip地址 | 一个值，比如用来描述这个ip成为攻击者的可疑程度 |

现在的问题就是如何评估每一个ip地址的可疑程度。证据肯定得从日志里找，拍了下脑袋，感觉可以从下面几个因素中造一个线性回归模型出来：

- 在时间尺度上，某一ip地址访问的密集程度（密集程度越高越可疑，比如说在某一时间攻击者直接拿nmap或者其他扫描器给你来一梭子）
- 检查请求的url，有些url是比较敏感的（比如后台管理/admin）。访问了敏感的路径就会增加可疑程度。

但是站在攻击者的角度上想，我ip是可以改变的，github上就有现成的ip代理库。那拿请求ip的密集程度来评估行为就不太行了。访问url我觉得比较可以，我现在的知识还想不出什么绕过的方法。但是有限的知识下，自己能够想到的因素也非常有限。

突然想起应该是大一的时候去听过一场讲座（2018年11月的一流网络安全学院建设发展论坛，360赞助），有拿机器学习做安全风控的。迁移一下把ai放在攻击溯源上，我觉得挺不错。机器学习懂的不多，我最多就是在数模写论文的时候接触到一些晦涩难懂的概念。我觉得之后得学一学。



### 后续

metasploit/kali linux

把步骤搞清晰

（防火墙日志/sys日志/......）

